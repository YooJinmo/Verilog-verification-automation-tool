name: Verilog Verification Automation

on:
  schedule:
    - cron: "*/1 * * * *"  # 매 1분마다 실행
  workflow_dispatch:  # 수동 실행 가능

jobs:
  run_verification:
    runs-on: ubuntu-latest

    steps:
    - name: 저장소 체크아웃
      uses: actions/checkout@v4

    - name: Install Icarus Verilog
      run: sudo apt-get update && sudo apt-get install -y iverilog  # iverilog 설치
      
    - name: Python 환경 설정
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"

    - name: 필요한 패키지 설치
      run: |
        sudo apt update
        sudo apt install -y iverilog cpp
        pip install pyverilog
        
    - name : verilog file 만들기
      run: python generate_vfile.py

    - name : adder_n.v 파일 추가 (커밋 및 푸시)
      run:  |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions@github.com"
        git add adder_n.v # github에 추가
        git commit --allow-empty -m "Update adder_n.v (auto)"
        git push --force

    - name : verilog tb 만들기
      run: python generate_tb.py

    - name : adder_tb.v 파일 추가 (커밋 및 푸시)
      run:  |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions@github.com"
        git add adder_tb.v # github에 추가
        git commit --allow-empty -m "Update adder_tb.v (auto)" # 변경 사항이 있을 경우 commit
        git push --force

    - name: input.txt generate 및 edge case 추가
      run: |
        python generate_input.py
        python edge_case/edge_case.py
      working-directory: ${{ github.workspace }}

    - name: edge_case.py을 통해 edge case들 input.txt 파일에 추가
      run: |
        chmod +x edge_case/edge_case.py  # 실행 권한 부여
        python edge_case/edge_case.py  # Python 파일 실행

    - name: input.txt 확인 (디버깅)
      run: |
        echo "===== input.txt 내용 확인 ====="
        cat input.txt  # input.txt의 내용을 출력하여 정상적으로 추가되었는지 확인

    - name: input.txt 파일 git에 추가(커밋 및 푸시)
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions@github.com"

        git status  # 변경 사항 확인
        git add input.txt --force  # 변경 사항 강제 추가
        git commit --allow-empty -m "Update input.txt with edge cases (auto)"
        git push --force
    

    - name:  Run Verilog
      run: iverilog -o adder_sim adder.v adder_n.v adder_tb.v  # Verilog 컴파일

    - name: Run Verilog Simulation
      run: vvp adder_sim  # 시뮬레이션 실행

    - name: Upload Simulation Output
      uses: actions/upload-artifact@v4
      with:
        name: simulation-output
        path: verilog_output.txt  # GitHub Actions에서 실행된 결과를 다운로드 가능하게 저장

    - name: verilog_output.txt 파일 git에 추가(커밋 및 푸시)
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions@github.com"
        git add verilog_output.txt # verilog_output.txt를 github에 추가
        git commit -m "Update verilog_output.txt (auto)" # 변경 사항이 있을 경우 commit
        git push --force

    - name: 결과 비교
      run: python compare_files.py

    - name: 결과를 csv 파일로 저장
      run: python txt_to_csv.py

    - name: 변경 사항 커밋 및 푸시
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions@github.com"
        git add comparison_output.csv # 비교 결과 데이터 csv를 github에 추가
        git commit -m "Update comparison_output.csv (auto)" # 변경 사항이 있을 경우 commit
        git push # 변경 사항을 git에 push

    - name: 성공률 도출후 txt 파일로 저장
      run: python success_per.py

    - name: success_per.txt 파일 git에 추가(커밋 및 푸시)
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions@github.com"
        git add success_per.txt # verilog_output.txt를 github에 추가
        git commit -m "Update success_per.txt (auto)" # 변경 사항이 있을 경우 commit
        git push --force

      continue-on-error: true #파일 변경이 없을 경우 오류 무시
      
